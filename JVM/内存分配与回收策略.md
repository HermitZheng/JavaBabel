# 内存分配与回收策略

### Minor GC 和 Full GC

- Minor GC：回收新生代，因为新生代对象存活时间很**短**，因此 Minor GC 会**频繁**执行，执行的速度一般也会比较**快**。
- Full GC：回收老年代和新生代，老年代对象其存活时间**长**，因此 Full GC **很少**执行，执行速度会比 Minor GC **慢**很多。

## 内存分配策略

### 1. 对象优先在Eden分配

大多数情况下，对象在新生代Eden区中分配。当Eden区没有足够空间时，虚拟机将发起一次Minor GC。

### 2. 大对象直接进入老年代

大对象指需要大量连续内存的Java对象，例如很长的字符串或者数量庞大的数组。

特别是当出现许多“朝生夕灭”的大对象时，经常会提前触发垃圾收集以获取足够的连续空间。

-XX:PretenureSizeThreshold参数，指定大于该设置值的对象直接在老年代分配内存，避免在Eden与两个Survivor区之间来回复制而产生的大量内存复制操作。



### 3. 长期存活的对象将进入老年代

虚拟机给每个对象都定义了一个年龄计数器，对象通常在Eden诞生，当经历了一次Minor GC存活后，并且被Survivor所容纳，对象的年龄就增长1岁。增加一定的年龄之后，对象就会被移动到老年代中。

-XX:MaxTenuringThreshold参数设置对象晋升老年代的阈值。



### 4. 动态对象年龄判定

虚拟机并不是永远要求对象的年龄必须达到 MaxTenuringThreshold 才能晋升老年代，**如果在 Survivor 中相同年龄所有对象大小的总和大于 Survivor 空间的一半**，则年龄**大于或等于**该年龄的对象可以直接进入老年代，无需等到 MaxTenuringThreshold 中要求的年龄。



### 5. 空间分配担保

在发生Minor GC之前，虚拟机必须先检查老年代**最大可用连续空间**是否大于新生代**所有对象总空间**。如果这个条件成立，那么这一次Minor GC可以确保是安全的。

如果不成立，虚拟机会查看-XX:HandlePromotionFailure参数的设置值是否允许**担保失败**。

如果允许，那会继续检查老年代的**最大可用连续空间**是否大于**历次晋升**到老年代对象的**平均大小**，如果大于，将尝试进行一次Minor GC，尽管这是有风险的；如果小于，或者参数设置为不允许冒险，则改为进行一次Full GC。

取历史平均值来比较其实有风险，假如某次Minor GC后存活的对象突增，远远高于历史平均值的话，依然会导致担保失败。于是只好重新发起一次Full GC，这样停顿时间就很长了。



## Full GC 的触发条件

对于 Minor GC，其触发条件非常简单，当 **Eden 空间满时**，就将触发一次 Minor GC。而 Full GC 则相对复杂，有以下条件：

### 1. 调用 System.gc()

只是建议虚拟机执行 Full GC，但是虚拟机不一定真正去执行。不建议使用这种方式，而是应该让虚拟机管理内存。

### 2. 老年代空间不足

老年代空间不足的常见场景为前文所讲的大对象直接进入老年代、长期存活的对象进入老年代等。

为了避免以上原因引起的 Full GC，应当尽量不要创建过大的对象以及数组。除此之外，可以通过 -Xmn 虚拟机参数调大新生代的大小，让对象尽量在新生代被回收掉，不进入老年代。还可以通过 -XX:MaxTenuringThreshold 调大对象进入老年代的年龄，让对象在新生代多存活一段时间。

### 3. 空间分配担保失败

使用复制算法的 Minor GC 需要老年代的内存空间作担保，如果担保失败会执行一次 Full GC。具体内容请参考上面的第 5 小节。

### 4. JDK 1.7 及以前的永久代空间不足

在 JDK 1.7 及以前，HotSpot 虚拟机中的方法区是用永久代实现的，永久代中存放的为一些 Class 的信息、常量、静态变量等数据。

当系统中要加载的类、反射的类和调用的方法较多时，永久代可能会被占满，在未配置为采用 CMS GC 的情况下也会执行 Full GC。如果经过 Full GC 仍然回收不了，那么虚拟机会抛出 java.lang.OutOfMemoryError。

为避免以上原因引起的 Full GC，可采用的方法为增大永久代空间或转为使用 CMS GC。

### 5. Concurrent Mode Failure

执行 CMS GC 的过程中同时有对象要放入老年代，而此时老年代空间不足（可能是 GC 过程中浮动垃圾过多导致暂时性的空间不足），便会报 Concurrent Mode Failure 错误，并触发 Full GC。